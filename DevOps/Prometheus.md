## Observability

- Ability to understand and measure the state of a system based upon data generated by the system.
- Three pillars of observability -
1. Logging - 
    - Logs are records of events that have occurred and encapsulate information about the specific event. 
    - Comprised of -
        - Timestamp of when the log occurred
        - Message containing information
2. Metrics -
    - Provide information about the state of a system using numerical values. Eg -
        - CPU load
        - Number of open files
        - HTTP response times
        - Number of errors
    - The data collected can be aggregated over time and graphed using visualization tools to identify trends over time.
    - Contain 4 pieces of information - `node_filesystem_avail_bytes{fstype="vfat", mountpoint="/home"} 5000 4:30AM 12/1/24` -
        a. Metric name (`node_filesystem_avail_bytes`)
        b. Metric value (`5000`) - latest value of the metric
        c. Timestamp (`4:30AM 12/1/24`) - timestamp at which the metric was collected
        d. Dimensions (`{fstype="vfat", mountpoint="/home"}`) - additional informations
3. Traces - 
    - Allow you to follow operations as they traverse through various systems & services.
    - Each trace has a `trace-id` to identify a request as it traverses the system.
    - Individual events forming a trace are called **spans**.
    - Each span tracks the following -
        - Start time
        - Duration
        - Parent id - what was responsible for triggering the span

- **Prometheus** is a monitoring solution that is responsible for collecting and aggregating metrics.

## SLI/SLO/SLA
- **Service Level Indicator (SLI)** -
    - quantitative measure of some aspect of the level of service.
    - Common SLIs -
        - Request Latency
        - Error Rate
        - Saturation
        - Throughput
        - Availability
- **Service Level Object (SLO)** -
    - target value or range for an SLI.
    - Example - if SLI is latency then SLO can be latency < 100ms
    - Main purpose is to quantify reliability of a product to a customer.
- **Service Level Agreement (SLA)** -
    - contract between a vendor and a user that gurantees a certain SLO.
    
## Prometheus

- Prometheus is an open-source tool that collects metrics data and provide tools to visualize the collected data.
- Designed to monitor time-series data that is _numeric_.
- Written in Golang.
- Allows you to generate alerts when metrics reach a user specified thresholds.
- Collects metrics by sending http requests to `/metric` (by default) endpoint of each target.
- Components -
    - **Retrieval** - responsible for collecting metrics data from targets by sending the HTTP request.
    - **Time-series DB (TSDB)** - The data is then stored into time-series database.
    - **HTTP Server** - accepts PromQl queries that retrieves the stored data from the database.
    - **Exporters** - mini processes running on the target that collects metrics and expose them in a format prometheus expects. Note that prometheus _pulls_ the data from target.
    - **Pushgateway** - used for short-lived jobs where prometheus will not have enough time to pull the data, the target can _push_ the data to the gateway and then prometheus can pull the data from the gateway like any other target.
    - **Service Discovery** - prometheus excepts hard-coded list of targets and for this we need a config file. For dynamic environments, service discovery provides the updated list of targets to prometheus.
    - **Alert Manager** - responsible for alerting. When alert is triggered, prometheus pushes the alert to AlertManager.
    - **Prometheus UI** / **Grafana** - accepts PromQl queries and displays the data.

- Prometheus has several native exporters like - Node exporters (Linux servers), Windows, MySQL, Apache, HAProxy

### Benefits of Pull-based system
- Easier to tell if a target is down. In a push-based system, we don't know if the target is down or has been decommissioned.
- Push-based systems can potentially overload metrics server if too many incoming connections get flooded at the same time.
- Pull-based systems have a definitive list of targets to monitor, creating a central source of truth.

## Installation

- Download [Prometheus](https://prometheus.io/download/) or copy the url and use `wget <download_link>` to download the binaries.
- Untar the binaries - `tar xvf <file_name>`
- Main files -
    - **prometheus** - application executable
    - **prometheus.yml** - config file
    - **promtool** - command-line utility
- Starting prometheus in foreground - `./prometheus`
- Prometheus UI (default port is `9090`) - `http://localhost:9090`

> [!TIP]
> Prometheus is configured to monitor itself by default.

- In search bar, write `up` and click `Execute`. `up` is a PromQl query that returns the status of each target. The `1` or `0` on the right next to target means either the target is up or down respectively.

- To start prometheus as a background service that can automatically start on system reboot - `systemctl start prometheus`. Steps -
    - Create prometheus user - `sudo useradd --no-create-home -shell /bin/false prometheus`
        - `--no-create-home` implies that user can't actually login as this user is only used for starting up prometheus.
    - Create required directories -
        - `sudo mkdir /etc/prometheus` - to store yaml config
        - `sudo mkdir /var/lib/prometheus` - to store the time-series data
        - `sudo chown prometheus:prometheus /etc/prometheus` 
        - `sudo chown prometheus:prometheus /var/lib/prometheus` 
    - Copy prometheus executable promtool -
        - `sudo cp prometheus /usr/local/bin`
        - `sudo cp promtool /usr/local/bin`
        - `sudo chown prometheus:prometheus /usr/local/bin/prometheus` 
        - `sudo chown prometheus:prometheus /usr/local/bin/promtool` 
    - Copy console directories -
        - `sudo cp -r consoles /etc/prometheus`
        - `sudo cp -r console_libraries /etc/prometheus`
        - `sudo chown -R prometheus:prometheus /etc/prometheus/consoles` 
        - `sudo chown -R prometheus:prometheus /etc/prometheus/console_libraries` 
    - Copy configuration file -
        - `sudo cp prometheus.yml /etc/prometheus/prometheus.yml`
        - `sudo chown prometheus:prometheus /etc/prometheus/prometheus.yml`
    - Create unix service file - `sudo vi /etc/systemd/system/prometheus.service` -
    ```
    [Unit]
    Description=Prometheus
    # Start service after network is up
    Wants=network-online.target
    After=network-online.target

    [Service]
    User=prometheus
    Group=prometheus
    Type=simple

    # Command to start prometheus
    ExecStart=sudo -u prometheus /usr/local/bin/prometheus \
            --config.file /etc/prometheus/prometheus.yml \
            --storage.tsdb.path /var/lib/prometheus/ \
            --web.console.templates=/etc/prometheus/consoles \
            --web.console.libraries=/etc/prometheus/console_libraries
    
    [Install]
    # Start service as part of normal system startup whether or not local GUI is active
    WantedBy=multi-user.target
    ```

    - Run `sudo systemctl daemon-reload`
    - Finally, start prometheus - `sudo systemctl start prometheus`
    - To start prometheus on system boot - `sudo systemctl enable prometheus`

    

    

